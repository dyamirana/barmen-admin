<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Бармен — админка</title><style>:root{color-scheme:light dark;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;--bg:#0f172a;--card:#1e293b;--accent:#14b8a6;--accent-hover:#0d9488;--border:rgba(255, 255, 255, 0.1);--text:#f8fafc;--text-muted:#94a3b8}*,::after,::before{box-sizing:border-box}body{margin:0;background:linear-gradient(135deg,#020617,#0f172a);color:var(--text);min-height:100vh}.page{max-width:960px;margin:0 auto;padding:32px 16px 64px}h1{font-size:1.75rem;text-align:center;margin-bottom:32px}h2{margin:0 0 12px;font-size:1.25rem}.grid{display:grid;gap:16px}.card{background-color:rgba(15,23,42,.9);border-radius:16px;padding:20px;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.35)}label{display:block;font-size:.9rem;margin-bottom:6px;color:var(--text-muted)}input,select{width:100%;border-radius:12px;border:1px solid var(--border);padding:10px 12px;font-size:1rem;background-color:rgba(15,23,42,.6);color:var(--text)}button:focus,input:focus,select:focus{outline:2px solid var(--accent);outline-offset:1px}button{border:none;border-radius:12px;padding:8px 14px;font-weight:600;font-size:.95rem;cursor:pointer;color:#0f172a;background:var(--accent);transition:background .2s ease}button.icon{width:36px;height:36px;padding:0;display:inline-flex;align-items:center;justify-content:center}button.secondary{background:rgba(255,255,255,.08);color:var(--text)}button.danger{background:#e11d48;color:#fff}button+button{margin-left:8px}.row{display:flex;gap:12px;flex-wrap:wrap}.row>*{flex:1;min-width:140px}.section-header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}.section-actions{display:flex;justify-content:flex-end;flex-wrap:wrap;gap:8px;margin-top:16px}.list-header{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));text-transform:uppercase;font-size:.75rem;letter-spacing:.08em;color:var(--text-muted);border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:12px;gap:12px}.badge{padding:2px 8px;border-radius:999px;font-size:.8rem;border:1px solid var(--border);color:var(--text-muted)}#ingredient-rows,#pump-rows,.components{display:flex;flex-direction:column;gap:12px}.components{margin-top:8px}.component-row,.ingredient-row,.pump-row{position:relative;display:flex;flex-wrap:wrap;gap:12px;padding:16px;padding-right:64px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background-color:rgba(15,23,42,.75);box-shadow:inset 0 0 0 1px rgba(148,163,184,.08)}.component-row input,.component-row select,.ingredient-row input,.pump-row select{flex:1 1 180px;min-width:0}.component-row button,.ingredient-row button,.pump-row button{position:absolute;top:12px;right:12px;margin:0}#recipe-list{display:flex;flex-direction:column;gap:16px}.recipe-row{display:flex;flex-direction:column;gap:16px}.recipe-row .row{flex-direction:column}.recipe-row .row>*{min-width:100%}#ingredients-section .list-header{grid-template-columns:minmax(110px,160px) minmax(200px,1fr) auto}#pumps-section .list-header{grid-template-columns:minmax(180px,1fr) minmax(80px,110px) auto}.recipe-actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;margin-top:12px}.empty-message{color:var(--text-muted);font-style:italic}@media (max-width:640px){.card{padding:16px}.row{flex-direction:column}.row>*{min-width:100%}.section-header{flex-direction:column;align-items:flex-start}#ingredients-section .list-header,#pumps-section .list-header{display:none}.component-row,.ingredient-row,.pump-row{grid-template-columns:1fr}.component-row button,.ingredient-row button,.pump-row button{justify-self:flex-start}.components{border-left:none;border-top:2px dashed rgba(255,255,255,.08);padding-left:0;padding-top:12px;margin-left:0}.recipe-actions{justify-content:flex-start}}</style></head><body><main class="page"><h1>Панель бармена</h1><div class="grid"><section class="card" id="wifi-section"><h2>Wi-Fi</h2><div class="row"><div><label for="wifi-ssid">SSID</label> <input id="wifi-ssid" type="text" placeholder="BarMachine"></div><div><label for="wifi-password">Пароль</label> <input id="wifi-password" type="password" placeholder="•••••••"></div></div><div class="section-actions"><button id="wifi-save">Сохранить</button> <span class="badge" id="wifi-status"></span></div></section><section class="card" id="ingredients-section"><div class="section-header"><h2 style="margin:0">Ингредиенты</h2><button class="secondary" id="ingredient-add">+ добавить</button></div><div class="list-header"><span>Короткое имя</span> <span>Отображаемое имя</span> <span></span></div><div id="ingredient-rows"></div><p class="empty-message" id="ingredient-empty" hidden>Ингредиенты не заданы</p><div class="section-actions"><button id="ingredient-save">Сохранить</button> <span class="badge" id="ingredient-status"></span></div></section><section class="card" id="recipes-section"><div class="section-header"><h2 style="margin:0">Рецепты</h2><button class="secondary" id="recipe-add">+ рецепт</button></div><div id="recipe-list"></div><p class="empty-message" id="recipe-empty" hidden>Рецептов пока нет</p><div class="section-actions"><button id="recipe-save">Сохранить</button> <span class="badge" id="recipe-status"></span></div></section><section class="card" id="pumps-section"><div class="section-header"><h2 style="margin:0">Помпы</h2><button class="secondary" id="pump-add">+ назначение</button></div><div class="list-header"><span>Ингредиент</span> <span>Помпа</span> <span></span></div><div id="pump-rows"></div><p class="empty-message" id="pump-empty" hidden>Назначения отсутствуют</p><div class="section-actions"><button id="pump-save">Сохранить</button> <span class="badge" id="pump-status"></span></div></section></div></main><template id="ingredient-row-template"><div class="ingredient-row"><input type="text" placeholder="rum" data-field="short"> <input type="text" placeholder="Ром" data-field="name"> <button class="danger icon" data-action="remove">×</button></div></template><template id="component-row-template"><div class="component-row"><select data-field="ingredient"></select> <input type="number" min="0" step="5" placeholder="60" data-field="weight"> <button class="danger icon" data-action="remove">×</button></div></template><template id="recipe-template"><div class="recipe-row card" style="padding:16px;margin-bottom:12px"><div class="row"><div><label>Название</label> <input type="text" placeholder="Пина колада" data-field="name"></div></div><div class="components"></div><div class="recipe-actions"><button class="secondary" data-action="add-component">+ ингредиент</button> <button class="danger" data-action="remove-recipe">Удалить рецепт</button></div></div></template><template id="pump-row-template"><div class="pump-row"><select data-field="ingredient"></select> <select data-field="pump"></select> <button class="danger icon" data-action="remove">×</button></div></template><script>const endpoints={config:"/config",ingredients:"/ingredients",recipes:"/cocktail_recipes",pumps:"/pump_assigment"};let state={ingredients:[],recipes:[],pumps:[]};const ingredientRows=document.getElementById("ingredient-rows"),ingredientEmpty=document.getElementById("ingredient-empty"),recipeList=document.getElementById("recipe-list"),recipeEmpty=document.getElementById("recipe-empty"),pumpRows=document.getElementById("pump-rows"),pumpEmpty=document.getElementById("pump-empty"),ingredientTemplate=document.getElementById("ingredient-row-template"),recipeTemplate=document.getElementById("recipe-template"),componentTemplate=document.getElementById("component-row-template"),pumpTemplate=document.getElementById("pump-row-template");function confirmRemoval(e){return window.confirm(e)}async function init(){await Promise.all([loadConfig(),loadIngredients(),loadRecipes(),loadPumps()])}async function loadConfig(){try{const e=await fetch(endpoints.config),t=await e.text(),[n="",i=""]=t.trim().split(";");document.getElementById("wifi-ssid").value=n,document.getElementById("wifi-password").value=i}catch(e){setStatus("wifi-status","Ошибка загрузки")}}async function loadIngredients(){try{const e=await fetch(endpoints.ingredients),t=(await e.text()).trim();state.ingredients=t?t.split(/\n+/).map(e=>{const[t="",n=""]=e.split(";");return{short:t.trim(),name:n.trim()}}):[],renderIngredients()}catch(e){setStatus("ingredient-status","Ошибка загрузки")}}async function loadRecipes(){try{const e=await fetch(endpoints.recipes),t=(await e.text()).trim();state.recipes=t?t.split(/\n+/).map(e=>{const[t="",n=""]=e.split(";"),i=n?n.split(",").map(e=>{const t=e.match(/(.+)\(([-\d.]+)\)/);return t?{ingredient:t[1].trim(),weight:t[2].trim()}:{ingredient:e.trim(),weight:""}}):[];return{name:t.trim(),components:i}}):[],renderRecipes()}catch(e){setStatus("recipe-status","Ошибка загрузки")}}async function loadPumps(){try{const e=await fetch(endpoints.pumps),t=(await e.text()).trim();state.pumps=t?t.split(/\n+/).map(e=>{const[t="",n=""]=e.split(";");return{ingredient:t.trim(),pump:n.trim()}}):[],renderPumps()}catch(e){setStatus("pump-status","Ошибка загрузки")}}function renderIngredients(){ingredientRows.innerHTML="",state.ingredients.length?(ingredientEmpty.hidden=!0,state.ingredients.forEach((e,t)=>{const n=ingredientTemplate.content.cloneNode(!0),i=n.querySelector(".ingredient-row"),a=i.querySelectorAll("input");a[0].value=e.short,a[1].value=e.name,a[0].addEventListener("input",t=>e.short=t.target.value),a[1].addEventListener("input",t=>e.name=t.target.value),i.querySelector('[data-action="remove"]').addEventListener("click",()=>{confirmRemoval("Удалить ингредиент?")&&(state.ingredients.splice(t,1),renderIngredients())}),ingredientRows.appendChild(n)})):ingredientEmpty.hidden=!1}function renderRecipes(){recipeList.innerHTML="",state.recipes.length?(recipeEmpty.hidden=!0,state.recipes.forEach((e,t)=>{const n=recipeTemplate.content.cloneNode(!0),i=n.querySelector(".recipe-row"),a=i.querySelector('[data-field="name"]');a.value=e.name,a.addEventListener("input",t=>e.name=t.target.value);const s=i.querySelector(".components"),r=()=>{if(s.innerHTML="",!e.components.length){const e=document.createElement("p");return e.className="empty-message",e.textContent="Ингредиенты не добавлены",void s.appendChild(e)}e.components.forEach((t,n)=>{const i=componentTemplate.content.cloneNode(!0),a=i.querySelector(".component-row"),o=a.querySelector("select");populateIngredientSelect(o,t.ingredient),o.addEventListener("change",e=>t.ingredient=e.target.value);const d=a.querySelector('[data-field="weight"]');d.value=t.weight,d.addEventListener("input",e=>t.weight=e.target.value),a.querySelector('[data-action="remove"]').addEventListener("click",()=>{confirmRemoval("Удалить ингредиент из рецепта?")&&(e.components.splice(n,1),r())}),s.appendChild(i)})};r(),i.querySelector('[data-action="add-component"]').addEventListener("click",()=>{e.components.push({ingredient:state.ingredients[0]?.short||"",weight:""}),r()}),i.querySelector('[data-action="remove-recipe"]').addEventListener("click",()=>{confirmRemoval("Удалить рецепт?")&&(state.recipes.splice(t,1),renderRecipes())}),recipeList.appendChild(n)})):recipeEmpty.hidden=!1}function renderPumps(){pumpRows.innerHTML="",state.pumps.length?(pumpEmpty.hidden=!0,state.pumps.forEach((e,t)=>{const n=pumpTemplate.content.cloneNode(!0),i=n.querySelector(".pump-row"),a=i.querySelector('[data-field="ingredient"]');populateIngredientSelect(a,e.ingredient,!0),a.addEventListener("change",t=>e.ingredient=t.target.value);const s=i.querySelector('[data-field="pump"]');populatePumpSelect(s,e.pump),s.addEventListener("change",t=>e.pump=t.target.value),i.querySelector('[data-action="remove"]').addEventListener("click",()=>{confirmRemoval("Удалить назначение помпы?")&&(state.pumps.splice(t,1),renderPumps())}),pumpRows.appendChild(n)})):pumpEmpty.hidden=!1}function populateIngredientSelect(e,t,n=!1){if(e.innerHTML="",n){const t=document.createElement("option");t.value="",t.textContent="— не задано —",e.appendChild(t)}state.ingredients.forEach(n=>{const i=document.createElement("option");i.value=n.short,i.textContent=`${n.short} — ${n.name}`,n.short===t&&(i.selected=!0),e.appendChild(i)}),!e.value&&state.ingredients[0]&&(e.value=state.ingredients[0].short)}function populatePumpSelect(e,t){const n=[{value:"-1",label:"Ручной налив"},...Array.from({length:6},(e,t)=>({value:String(t),label:String(t+1)}))];e.innerHTML="",n.forEach(n=>{const i=document.createElement("option");i.value=n.value,i.textContent=n.label,n.value===(t??"")&&(i.selected=!0),e.appendChild(i)}),e.value||(e.value="-1")}function setStatus(e,t){const n=document.getElementById(e);n.textContent=t,t&&setTimeout(()=>{n.textContent=""},4e3)}function formatIngredientsPayload(){return state.ingredients.filter(e=>e.short).map(e=>`${e.short};${e.name}`).join("\n")}function formatRecipesPayload(){return state.recipes.filter(e=>e.name).map(e=>{const t=e.components.filter(e=>e.ingredient&&""!==e.weight).map(e=>`${e.ingredient}(${e.weight})`).join(",");return`${e.name};${t}`}).join("\n")}function formatPumpsPayload(){return state.pumps.filter(e=>e.ingredient).map(e=>`${e.ingredient};${e.pump||-1}`).join("\n")}function validateRecipes(){for(const e of state.recipes){const t=new Set;for(const n of e.components){const i=n.ingredient?.trim();if(i){if(t.has(i))return`Ингредиент ${i} уже добавлен в рецепт "${e.name||"без названия"}"`;t.add(i)}if(!n.ingredient)continue;const a=n.weight??"";if(""===String(a).trim())return`Заполните вес для ингредиента в рецепте "${e.name||"без названия"}"`;const s=Number(a);if(!Number.isFinite(s)||s<=0)return`Некорректный вес ингредиента в рецепте "${e.name||"без названия"}"`}}return""}function validatePumps(){const e=new Set,t=new Map;for(const n of state.pumps){const i=n.ingredient?.trim(),a=(n.pump??"").toString().trim();if(i){if(e.has(i))return`Ингредиент ${i} уже привязан к другой помпе`;if(e.add(i),a&&"-1"!==a){if(t.has(a))return`Помпа ${a} уже занята ингредиентом ${t.get(a)}`;t.set(a,i)}}}return""}document.getElementById("ingredient-add").addEventListener("click",()=>{state.ingredients.push({short:"",name:""}),renderIngredients()}),document.getElementById("recipe-add").addEventListener("click",()=>{state.recipes.push({name:"",components:[]}),renderRecipes()}),document.getElementById("pump-add").addEventListener("click",()=>{state.pumps.push({ingredient:state.ingredients[0]?.short||"",pump:"-1"}),renderPumps()}),document.getElementById("wifi-save").addEventListener("click",async()=>{const e=`${document.getElementById("wifi-ssid").value};${document.getElementById("wifi-password").value}`;try{await fetch(endpoints.config,{method:"POST",headers:{"Content-Type":"text/plain"},body:e}),setStatus("wifi-status","Сохранено")}catch(e){setStatus("wifi-status","Ошибка")}}),document.getElementById("ingredient-save").addEventListener("click",async()=>{try{await fetch(endpoints.ingredients,{method:"POST",headers:{"Content-Type":"text/plain"},body:formatIngredientsPayload()}),setStatus("ingredient-status","Сохранено"),await loadIngredients()}catch(e){setStatus("ingredient-status","Ошибка")}}),document.getElementById("recipe-save").addEventListener("click",async()=>{const e=validateRecipes();if(e)setStatus("recipe-status",e);else try{await fetch(endpoints.recipes,{method:"POST",headers:{"Content-Type":"text/plain"},body:formatRecipesPayload()}),setStatus("recipe-status","Сохранено"),await loadRecipes()}catch(e){setStatus("recipe-status","Ошибка")}}),document.getElementById("pump-save").addEventListener("click",async()=>{const e=validatePumps();if(e)setStatus("pump-status",e);else try{await fetch(endpoints.pumps,{method:"POST",headers:{"Content-Type":"text/plain"},body:formatPumpsPayload()}),setStatus("pump-status","Сохранено"),await loadPumps()}catch(e){setStatus("pump-status","Ошибка")}}),init()</script></body></html>